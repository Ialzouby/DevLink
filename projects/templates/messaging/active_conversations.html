{% extends 'projects/base.html' %}
{% load static %}

{% block content %}
<div class="messaging-container">
    <!-- Top Controls -->
    <div class="top-controls">
        <!-- Project Filter Dropdown -->
        <div class="dropdown filter-projects">
            <button class="dropdown-btn">All Projects â¬‡</button>
            <div class="dropdown-content" id="projectDropdown">
                {% for project in projects %}
                    <a href="#" onclick="filterMessages('{{ project.id }}')">{{ project.title }}</a>
                {% endfor %}
            </div>
        </div>

        <!-- Search Bar -->
        <input type="text" class="search-bar-22" placeholder="Search...">

        <!-- Start Chat Dropdown -->


        <!-- Start Chat Dropdown -->
                <div class="dropdown start-chat">
                    <button class="dropdown-btn" onclick="toggleStartChat(event)">Start Chat âž•</button>
                    <div class="dropdown-content start-chat-dropdown" id="startChatDropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-title">Projects</div>
                            {% for project in projects %}
                                <a href="#" onclick="startChat('{{ project.id }}')">{{ project.title }}</a>
                            {% endfor %}
                        </div>
                        <div class="dropdown-section">
                            <div class="dropdown-title">Friends</div>
                            {% for user in friends %}
                                <a href="#" onclick="startChat('{{ user.username }}')">{{ user.username }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

    <!-- Main Chat Layout -->
    <div class="chat-layout">
        <!-- Sidebar (Active Chats) -->
        <div class="chat-sidebar">
            <h2 class="sidebar-title">Active Chats</h2>
            <ul class="chat-list">
                {% for chat in chats %}
                    <li class="chat-item" onclick="openChat('{{ chat.id }}')">
                        <img src="{{ chat.get_avatar_url }}" alt="User" class="chat-avatar">
                        <div class="chat-details">
                            <span class="chat-name">{{ chat.name }}</span>
                            <span class="chat-last-message">{{ chat.last_message }}</span>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Chat View -->
        <div class="chat-view">
            <div class="chat-header">Select a chat to start messaging</div>
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will load dynamically here -->
            </div>
            <div class="message-input">
                <button class="attach-btn">âž•</button>
                <button class="attach-btn">ðŸ˜€</button>

                <input type="text" class="message-text2" placeholder="Type here...">
                <button class="send-btn">âž¤</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function showStep(step) {
    console.log('Showing step:', step);

    // Ensure the element exists before applying styles
    const stepElement = document.getElementById(`step-${step}`);
    if (stepElement) {
        // Hide all steps
        document.querySelectorAll('.step').forEach(stepElement => {
            stepElement.style.display = 'none';
        });

        // Show active step
        stepElement.style.display = 'block';  // Only apply styles if the element exists
    } else {
        console.error(`Step element step-${step} not found.`);
    }
}

document.addEventListener("DOMContentLoaded", function () {
    const startChatDropdown = document.getElementById("startChatDropdown");

    window.toggleStartChat = function (event) {
        event.stopPropagation(); // Prevents event bubbling

        // Close other open dropdowns
        document.querySelectorAll(".dropdown-content").forEach(dropdown => {
            if (dropdown !== startChatDropdown) {
                dropdown.classList.remove("show");
            }
        });

        // Toggle the visibility of the dropdown
        if (startChatDropdown.classList.contains("show")) {
            startChatDropdown.classList.remove("show");
        } else {
            startChatDropdown.classList.add("show");
        }
    };

    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
        if (!event.target.closest(".start-chat")) {
            startChatDropdown.classList.remove("show");
        }
    });
});

    document.addEventListener("DOMContentLoaded", function() {
        const messagesContainer = document.getElementById("messagesContainer");
        const messageInput = document.querySelector(".message-text2");
        const sendButton = document.querySelector(".send-btn");

        let activeChatId = null;

        // Function to open a chat and load messages
        window.openChat = function(chatId) {
            console.log("Opening chat:", chatId);
            activeChatId = chatId;

            fetch(`/conversations/${chatId}/messages/`)
                .then(response => response.json())
                .then(data => {
                    messagesContainer.innerHTML = ""; // Clear messages
                    data.messages.forEach(msg => {
                        const messageElement = document.createElement("div");
                        messageElement.innerHTML = `<strong>${msg.sender}:</strong> ${msg.content} <small>${msg.timestamp}</small>`;
                        messagesContainer.appendChild(messageElement);
                    });
                });
        };

        // Function to send a message
        sendButton.addEventListener("click", function() {
            if (!activeChatId || messageInput.value.trim() === "") return;

            fetch(`/conversations/${activeChatId}/send/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCSRFToken()
                },
                body: `content=${encodeURIComponent(messageInput.value)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageElement = document.createElement("div");
                    messageElement.innerHTML = `<strong>${data.message.sender}:</strong> ${data.message.content} <small>${data.message.timestamp}</small>`;
                    messagesContainer.appendChild(messageElement);
                    messageInput.value = ""; // Clear input
                }
            });
        });

        // Function to get CSRF token for Django POST requests
        function getCSRFToken() {
            const csrfToken = document.cookie.split("; ").find(row => row.startsWith("csrftoken="));
            return csrfToken ? csrfToken.split("=")[1] : "";
        }
    });
</script>




<style>
    /* Prevent scrolling on the full page */
    html, body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
        font-family: Arial, sans-serif;
        background: #F5F5F5;
    }

    /* Full Page Container */
    .messaging-container {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 15px;
        box-sizing: border-box;
        gap: 15px;
    }
/* Fix: Remove overflow hidden */
.messaging-container {
    overflow: visible !important;
}

.chat-layout {
    overflow: visible !important;
}

    /* Top Controls */
    .top-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        gap: 15px;
        margin-top: -45px;
    }

    .dropdown {
        position: relative;
        display: inline-block;
        width: 22%;
        min-width: 300px;
    }

    .dropdown-btn {
        border: 2px solid rgb(174, 174, 174);
        border-radius: 20px;
        padding: 10px;
        background: white;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        text-align: center;
    }

    .search-bar-22 {
        border: 2px solid rgb(174, 174, 174);
        background-color: white!important;
        border-radius: 20px!important;
        padding: 10px!important;
        width: 22%!important;
        text-align: center!important;
        margin-top: 18px;

    }

    /* Chat Layout */
    .chat-layout {
        display: flex;
        width: 100%;
        height: 70vh; /* Reduce height to avoid full-screen overflow */
        gap: 20px;
    }

    /* Sidebar */
    .chat-sidebar {
        width: 25%;
        background: white;
        border-radius: 20px;
        border: 2px solid rgb(174, 174, 174);
        padding: 10px;
        height: 70vh; /* Reduce height */
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.1);
    }

    .chat-view {
        width: 75%;
        background: white;
        border-radius: 20px;
        border: 2px solid rgb(174, 174, 174);
        display: flex;
        flex-direction: column;
        height: 70vh; /* Reduce height */
        overflow: hidden;
        box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.1);
    }

    /* Sidebar Content */
    .chat-list {
        list-style: none;
        padding: 0;
        overflow-y: auto;
        flex-grow: 1;
    }

    .chat-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid black;
        cursor: pointer;
        border-radius: 10px;
        margin-bottom: 5px;
        transition: background 0.3s ease-in-out;
    }

    .chat-item:hover {
        background: #EAEAEA;
    }

    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .chat-name {
        font-weight: bold;
    }

    .messages-container {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
    }

    /* Input Area */
    .message-input {
        display: flex;
        padding: 10px;
        border: 2px solid rgb(174, 174, 174);
        background: rgb(166, 166, 166);
        border-radius: 0 0 10 10px;
        align-items: center;
        gap: 10px;
        max-height: 70px;
    }

    .attach-btn, .send-btn {
        border: none;
        background: black;
        color: white;
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
    }

    .message-text2 {
        flex: 1;
        padding: 10px;
        border: 2px solid black;
        border-radius: 20px!important;
        background-color: white!important;
        margin-top: 18px;
    }
    /* Dropdown Fix: Ensures it appears over content */
/* Fix dropdown positioning so it appears over content */
.start-chat {
    position: relative; /* Ensures dropdown stays anchored to this button */
}

.start-chat-dropdown {
    position: absolute;
    top: 100%; /* Ensures it appears right below the button */
    left: 0;
    width: 100%;
    background: white;
    border: 2px solid rgb(174, 174, 174);
    border-radius: 20px;
    z-index: 9999; /* Ensures dropdown appears above other content */
    box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.1);
    padding: 10px;
    display: none; /* Hidden by default */
}

/* Ensure dropdown becomes visible when the "show" class is added */
.start-chat-dropdown.show {
    display: block!important;
}

/* Prevent content shifting */
.dropdown-section {
    padding: 10px;
    border-bottom: 2px solid rgb(174, 174, 174);
}

.dropdown-section:last-child {
    border-bottom: none;
}

.dropdown-title {
    font-weight: bold;
    padding-bottom: 5px;
    text-align: center;
}

.start-chat-dropdown a {
    display: block;
    padding: 8px;
    border-radius: 10px;
    transition: background 0.3s;
    text-align: center;
}

.start-chat-dropdown a:hover {
    background: #f0f0f0;
}

</style>

{% endblock %}
